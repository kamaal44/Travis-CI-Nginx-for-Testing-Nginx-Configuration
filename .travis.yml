language: php
env:
  global:
    - secure: nVvz2uYtMyMgouT1WHPAUK6j/O4Ya0xXMvPl7VfXd0MyY/4ztbX9wZvLDdyFC9/XSJrFo+Zsj/XUk1fgEtDb1oJP31I99wWWdE4Z+yuSyCo6XtEgoaPJ94gZnpMQqdstceZ4VxnNY+1Czk0g6U5poV98s1+Q5+nSBKbCkSgk8l7uEpG76wnMtZlEd2L95lKMtixcoXhl4O/gzJbQBzJNhYic8jlzrCmYBAnfZWBZf+VNrppz6ReBc2aI82OQQiY2nBKOgTPojpp4+0nNl39c6InmZqIeUk16WZPXe+c8OgOwfM5XRJvOZN36QcjY7M+kcL7FtfzOjpmJq1+ukfCW2T9LvcLo0zb6HjMdXzBdFLlQQWZfd6qQZn5yNklJ5vVlE9BQTTmySSW92G264/53+IOSNCyhDTkH8sbntD/qWxGWavw9iIltzfX8NldB04BIR09JEi7o9rcDjV4QR4tXs183ooWxSX9h5Qth9Wm9nQRD/qP3iYKrJVub2RD8gp2KRJatnXny9bznm3ncsSl6+hJ+Xh2+P07ZfQH4Pc/a+bIgND18mTlS11Mi/uHYfFTMN45A//4o+EG1casWj3xt3ICrq2G7DEZnW/o/vkP2DqVUaDoWU2KWRMXk2f9p2oYAz8H7zhc2waEocmNwNybjV83HU8UdaiclDMzwMDalpS0=
    - GIT_NAME: TravisCI
    - GIT_EMAIL: mitchellkrog@gmail.com
    - TRAVIS_REPO_SLUG: mitchellkrogza/Travis-CI-Nginx-for-Testing-Nginx-Configuration
    - GIT_BRANCH: master
    
sudo: required
dist: trusty
matrix:
  include:
    - php: 7.0
  allow_failures:
    - php: 7.0
    - php: hhvm
  fast_finish: true
cache:
  - apt
addons:
  apt:
    packages:
      - realpath
      - mailutils

before_install:
  - export TZ=Africa/Johannesburg

install:
  - sudo add-apt-repository -y ppa:nginx/stable
  - sudo apt-get update
  - sudo apt-get install -y --force-yes nginx-extras

script:
  - travis-ci/install-nginx.sh
  - curl -vsf 'http://localhost:9000/index.php' &> /dev/stdout
  - curl -A "googlebot" http://localhost:9000/index.php &> /dev/stdout
  - STATUSCODE=$(curl -A "80legs" http://localhost:9000/index.php &> /dev/stderr --write-out "%{http_code}") | if test $STATUSCODE 52; then exit 0; fi
  - STATUSCODE=$(curl -A "masscan" http://localhost:9000/index.php &> /dev/stderr --write-out "%{http_code}") | if test $STATUSCODE 52; then exit 0; fi
  - STATUSCODE=$(curl -I http://localhost:9000/index.php -e http://100dollars-seo.com &> /dev/stderr --write-out "%{http_code}") | if test $STATUSCODE 52; then exit 0; fi
  - STATUSCODE=$(curl -I http://localhost:9000/index.php -e http://zx6.ru &> /dev/stderr --write-out "%{http_code}") | if test $STATUSCODE 52; then exit 0; fi
  - travis-ci/change-file.sh

before_deploy:
  - travis-ci/deploy-package.sh

deploy:
  provider: releases
  api_key:
    secure: ${GH_TOKEN}
  file:
  - "globalblacklist.conf"
  skip_cleanup: true
  on:
    repo: mitchellkrogza/Travis-CI-Nginx-for-Testing-Nginx-Configuration
    tags: false
    branches:
      except:
        - "/^v[0-9]/"
        - "/^V.*$/"
    branches:
       only:
         - "master"
notifications:
  email: false